# 6-2 HTTPS 协议概述

上一节初步认识了 HTTPS
更系统、更原理化学习 HTTPS 协议的设计和原理
目前很多、绝大多数网站都应用了 HTTPS

- HTTPS 可以认为是<span style="color:red;">HTTP+TLS</span>。
- TLS 是<span style="color:red;">传输层加密协议</span>，它的前身是 SSL 协议。

最早由网景公司（与微软打官司，协议解决了，但是被微软打败了）
最早比 IE 使用范围大的多，要牛的多这样的一个网景浏览器；

SSL 协议由网景公司 1995 年发布的；
1995 年经过 IETF 讨论和规范之后，改名成为了 TLS。SSL 和 TLS 说的都是一个协议。

## HTTP 和 TLS 在协议层的位置

可以认为 TLS 是建立在传输层和应用层之间；
TLS 实际上是 TCP 之上建立了一个加密通道；
TLS 协议主要有 5 个部分，包含着叫：应用数据层协议、握手协议、报警协议、加密消息确认协议和心跳协议这么 5 个部分；
目前，比较常用的 HTTP 协议是 HTTP1.1；
常用的 TLS 协议版本有这么几个：TLS1.2、TLS1.1、TLS1.0、SSL3.0 这么几个版本；
其中，SSL3.0 由于有一种攻击，叫做 POODLE 攻击；
由于这种攻击，认为 SSL3.0 协议它是不安全的；
但是统计发现仍然有不到 1%的浏览器，还是在使用 SSL3.0；
TLS1.0 呢也存在着部分的安全漏洞，比如像 RC4、BEAST 这种攻击方式；
TLS1.2 和 TLS1.1 暂时没有什么已知的安全漏洞，算是比较安全的；同时也有比较大量的扩展的访问速度的提升和性能的提升；
TLS1.3 现在也已经发布了，是 TLS 协议一个非常重大的变革；
不管是安全性还是用户的访问速度，都会有一个质的提升；
比如说现在打开 360 浏览器：
如果访问百度，百度的前面有一个小锁头，点击看到能够展示了目前使用的 TLS 版本，比如我是 1.2，然后我用什么加密的，我的身份验证是密钥交换机制是什么样子的。

那么，为什么要有 HTTPS 呢？

就像我们前面聊过的，HTTP 本身是明文传输的，没有经过任何的安全处理；例如，百度搜索一个关键字“苹果手机”，中间者完全能够查看这个消息，并且有可能打电话过来骚扰用户；
也有一些用户投诉百度的时候，发现在使用百度的过程中，首页或者结果页面浮了一条很长很长很大的广告，这也是中间者往页面插的广告；如果劫持技术比较低劣的话，用户甚至没有办法访问百度，直接被劫持走，更有我们前边故事里面说过的，不仅仅它可以窃听你的通信内容，甚至还可以去篡改你的内容；这里提到的中间者主要是指一些网络节点，是这种用户数据在浏览器和百度服务器中间传输必须要经过的那些节点；比如说像 WIFI 热点，路由器，防火墙，反向代理，缓存服务器等。这也是为什么一直有这个消息；就是说让大家不要随意乱用公共场合的 WIFI，很容易被中间人攻击；那么在这种 HTTP 协议下呢，中间人可以随意的去秀它用户的搜索内容，窃取客户的隐私，篡改网页，篡改消息；不过呢，我们的 HTTPS，就是这些劫持行为的克星，能够完全有效的进行防御，就像我们前面介绍过的；

总体来说，HTTPS 协议提供了三个比较强大的功能，来对抗上面提到的劫持行为；

1. 内容加密：浏览器到服务器的内容都是以加密形式来传输的，中间者无法直接查看原始内容；

2. 接下来就是身份认证：由于证书的存在，保证用户访问的是你想访问的服务；
   比如慕课看视频：HTTPS 证书保证了你此时访问的一定是慕课网，即使被 DNS 劫持到了第三方站点，也会提醒用户没有访问慕课服务，有可能被劫持，这么一些提示信息；

3. 数据完整性，防止内容被第三方冒充或者篡改。

HTTPS 是怎么做到这三点的呢？

其实前面，通过小风和小萌的故事，已经讲得非常清楚了。再来总结一下：
故事里为了能让小风更好的与小萌这个服务器加密通信，增加了很多的安全策略；
这其中就包含了：对称内容加密和非对称密钥交换这两项技术。

内容加密：

- 非对称密钥交换
- 对称内容加密

对称内容加密：的第一步：是协商加密算法和密钥，中间人依然可以在第一次通信的时候，直接去截获加密方式和密钥，这样有对称内容加密，就安全了；

而非对称加密，用这种公钥和私钥的方式，把这个正常通信的密钥 KEY2 协商好；但是在协商过程中，有一步是服务器把自己的公钥 KEY1 用明文传给客户端，这里边其实涉及非常多的高级算法，比如说，对称加密，又分为两种模式，对称加密有一种叫做流式加密，有一种叫做分组加密，流式加密现在常用的就是 RC4，但是前面我们说了，RC4 现在不太安全了，微软也是尽量建议网站不要使用 RC4 流式加密；一种新的替代 RC4 的流式加密算法叫做 ChaCha20，它是一个谷歌提出来的加密算法，速度更快，更安全，这么样一种加密算法；
另外一个就是分组加密，分组加密以前常用的模式是 AES-CBC，但是 CBC 已经被证明非常容易遭受到攻击（BEAST 和 LUCKY13）；目前呢，建议使用的分组加密模式是 AES-GCM，不过它的缺点是计算量特别大，性能和电量消耗都比较高；所以就不适用于移动端，比如像手机、平板电脑这些不太适用。

而非对称密钥交换的算法，本身就更加的复杂，密钥交换的过程涉及到随机数生成，摩指数运算，空白古奇、加密签名等等一系列操作；
常见的这种密钥交换算法，比较常用的像，RSA、DEH，DEH1，这样的一些等等的一些算法。这些算法都非常复杂，在对于HTTPS介绍和使用中，大家其实也没有必要去涉猎过多，大体像前面故事中了解到这个过程就OK了。但是我们也说了，在非对称密钥交换的过程中，中间人此时可以截获KEY1，掉包换成自己的公钥KEY3；
这样一来，中间人依然可以获取正常通信使用的密钥，通信仍然不安全，所以我们引入了数字证书来进行身份认证：
服务端会像权威机构申请证书，证书包含着我们前面说过的一些内容：证书机构、服务器网址、机构加密的私钥、私钥加密过的公钥、证书签名，等等一系列的信息；
客户端和服务端通信的时候，服务端先把证书传递给客户端，客户端收到证书之后，用证书机构的公钥解密证书签名，然后用签名生成的规则再生成一个签名，对比一致，它就是真证书，不一致那就是假证书；
如果确认它是真正书，解密服务器公钥KEY1，再生成通信任务的密钥KEY2，再用服务器端的公钥KEY1加密，发给服务端；这个权威证书也称之为CA证书。
那我们说这种CA证书是不是可信呢？当然可信了，因为这些厂商和浏览器，还有操作系统啊，都是有合作的，他们的公钥，都默认装到了浏览器或者操作系统的环境里面，比如说像Firefox自己就维护了一个叫做可信任的CA列表，而Chrome和IE使用的就是操作系统CA列表；

相信有了前面的故事，再加上我们刚刚介绍的HTTPS这些点，可能这些点听起来稍微有些枯燥无聊，但是大家协同前面介绍小风&小萌表白故事，相信大家能够对HTTPS有一些更直观的认识，也知道了，它到底是怎么保护我们的HTTP安全的了。我们也就对这种HTTP协议本身的安全性会更加放心一点。

## HTTPS 原理介绍

图：

```
—————————————
|    HTTP   |
—————————————
  |  SSL  |
—————————————
|     TCP   |
—————————————
|     IP    |
—————————————
| 数据链路层 |
—————————————
```

- 内容加密  
  非对称密钥交换  
  对称内容加密

- 身份认证  
  数字证书

- 数据完整性

